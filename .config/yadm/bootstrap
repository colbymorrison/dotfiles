#! /bin/bash

BASE="$HOME/.config/bootstrap"
YADM_CLASSES="$BASE/yadm-classes"
MANAGERS="$BASE/package-manager.json"
MAC_COREUTILS="$BASE/macos-gnu-coreutils"

function cmd_exists(){
	command -v $1 >/dev/null 2>&1 
}

#
# Usage: install_if_missing [cmd] [pkg_name]
#
function install_if_missing() {
	echo
	PKG=$1
	if [[ $# -ge 2 ]]; then
		PKG=$2
	fi


	if  ! cmd_exists $1; then
		echo "Installing $PKG"
		$INSTALL_CMD $PKG
		if ! cmd_exists $1; then
			echo "Failed to install $1"
			return 1
		fi
	else
		echo "$1 is already installed :)"
	fi
}

# -- jq check --
if ! cmd_exists jq; then
	echo "Please install jq (https://stedolan.github.io/jq/download/) and try again"
	exit 1
fi


# -- Detect package manager --
MANAGER=""
if [[ $OSTYPE == "linux-gnu" ]]; then
	for key in $(jq 'keys[]' $MANAGERS); do
		key=$(echo $key | sed s/\"//g)
		if cmd_exists $key; then
			MANAGER=$key
			break
		fi
	done
elif [[ $OSTYPE == "darwin"* ]]; then
	if ! cmd_exists "brew"; then
		echo "Intalling homebrew"
		$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)
	fi
	MANAGER="brew"
fi

if [[ $MANAGER == "" ]]; then
	echo "Couldn't find the pacakage manager for this system. Please add it to $MANAGERS"
	exit 1
fi

echo "Detected package manager as $MANAGER"

INSTALL_CMD="sudo $MANAGER $(jq .$MANAGER.install $MANAGERS | sed s/\"//g)"
UPDATE_CMD="sudo $MANAGER $(jq .$MANAGER.update $MANAGERS | sed s/\"//g)"

# -- Update --
# echo "Performing system update"
# $UPDATE_CMD

# -- Bash --
if ! echo $SHELL | grep "bash" > /dev/null 2>&1; then
	echo "Chaging shell to bash"
	chsh -s /bin/bash
fi

# -- Gnu Utils for Mac --
if [[ $OSTYPE == "darwin"* ]]; then
	for pkg in $MAC_COREUTILS; do
		install_if_missing $pkg
	done
fi

# -- Fzf --
if ! install_if_missing fzf; then
	echo "Please install fzf then try again. See https://github.com/junegunn/fzf#installation"
	exit 1
fi

# -- Yadm setup --
if [[ $(yadm config local.class) == "" ]]; then
	echo "Please choose a system type (yadm local.class)"
	YADM_CLASS=$(fzf < $YADM_CLASSES)
	yadm config local.class $YADM_CLASS
	yadm alt
	yadm checkout "$HOME" > /dev/null 2>&1
fi

# -- Tmux --
install_if_missing tmux

# -- vim-plug -- 
if [ ! -f ~/.vim/autoload/plug.vim ]; then
	printf "\nInstalling vim-plug"
	curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
	vim '+PlugInstall' '+UpdateRemotePlugins' 
fi

# -- Neovim --
install_if_missing nvim neovim

# -- wget --
install_if_missing wget


printf "\nComplete!\n"
